var PaymentWizard=function(){var data;var start=function($trContainer){};var update=function(d){data=d};return{update:update,start:start}};var initialize=function(docProxy,net,networkStatus){var $table=$("<table>");var $header=$("<div/>").addClass("header");var $helpContainer=$("<div/>").hide();var $messageContainer=$("<div/>").addClass("messagecontainer");$(document.body).append($("<div/>").addClass("root").append($messageContainer,$header,$helpContainer,$table));var table;var model=Model(function(newdata){table.update(newdata);paymentWizard.update(newdata);docProxy.update(newdata)});var isFirstTimeHere=function(){return docProxy.isFirstGeneration()};var paymentWizard=PaymentWizard();table=Table($header,$table,model,Help($helpContainer,net,networkStatus,isFirstTimeHere),paymentWizard);var onData=function(data){model.reset(data);table.update(data);paymentWizard.update(data)};docProxy.onData(onData);docProxy.read()};var startApp=function(){FastClick.attach(document.body);var errorHandler={fatal:bailout,info:info};var networkStatus=NetworkStatus();var net=Net(JobQueue(),errorHandler,networkStatus);var id=window.location.pathname.substring(1);var docProxy=DocProxy(LocalDoc(id,window.localStorage||{}),RemoteDoc(id,net),networkStatus,errorHandler);networkStatus.onChanged(setOnlineCss);networkStatus.onChanged(function(isOnline){if(isOnline){docProxy.read()}});initialize(docProxy,net,networkStatus);var ajaxTimer=null;var messageObj={hide:$.noop};$(document).ajaxStart(function(){if(networkStatus.isOnline){ajaxTimer=setTimeout(function(){messageObj=showMessage(L.Saving)},2e3)}});$(document).ajaxStop(function(){clearTimeout(ajaxTimer);messageObj.hide()})};var loadApp=function(){var net=Net({},{},NetworkStatus());net.create(function(url){window.location.href=url})};var transferPlan=function(balances){var MoneyTransfer=function(fromIndex,toIndex,amount){return{from:fromIndex,to:toIndex,amount:amount}};var IndexedBalance=function(i,balance){return{index:i,balance:balance}};var positives=[];var negatives=[];$.each(balances,function(i,value){if(value>0){positives.push(IndexedBalance(i,value))}else if(value<0){negatives.push(IndexedBalance(i,-value))}});var plan=[];var n=negatives.pop();var p=positives.pop();while(p&&n){var pReceived=0;var pIsSatisfied=false;do{var pRemains=p.balance-pReceived;pIsSatisfied=n.balance>=pRemains;var amount=pIsSatisfied?pRemains:n.balance;plan.push(MoneyTransfer(n.index,p.index,amount));pReceived+=amount;if(!pIsSatisfied){n=negatives.pop()}else{n.balance-=amount}}while(!pIsSatisfied&&n);p=positives.pop()}return plan};var testTransfer=function(balances){var sum=balances.reduce(function(a,b){return a+b});var normBalances=balances.map(function(v){return v-sum/balances.length});var plan=transferPlan(normBalances);var p=plan.pop();while(p){normBalances[p.from]+=p.amount;normBalances[p.to]-=p.amount;console.log(p.from+" -> "+p.to+": "+p.amount);p=plan.pop()}console.log(normBalances)};var isValidCellValue=function(text){var trimmed=text.replace(/ /g,"");return trimmed===""||parseFloat(trimmed)==trimmed};var toValidCellValue=function(text){var trimmed=text.replace(/ /g,"");return isNaN(parseFloat(trimmed))?null:parseFloat(trimmed)};var DataDiff=function(serverData,localData){var sameNamesAndPayments=function(){var acc=true;$.each(serverData.names,function(i,name){if(name!=localData.names[i]){acc=false;return false}});$.each(serverData.payments,function(i,payment){if(payment.text!=localData.payments[i].text){acc=false;return false}$.each(payment.values,function(j,value){if(value!==localData.payments[i].values[j]){acc=false;return false}})});return acc};var accepted=function(){if(serverData.title!=localData.title||localData.names.length!=serverData.names.length||localData.payments.length<serverData.payments.length){return false}return sameNamesAndPayments()};var isEmpty=function(){if(serverData.title!=localData.title||localData.names.length!=serverData.names.length||localData.payments.length!=serverData.payments.length){return false}return sameNamesAndPayments()};var paymentStats=function(index){return{localOnly:index<localData.payments.length&&index+1>serverData.payments.length}};var nameStats=function(index){return{localOnly:index<localData.names.length&&index+1>serverData.names.length}};var rebaseable=function(){var serverNewData=localData;if(serverData.names.length!=serverNewData.names.length){return false}for(var i=0;i<serverData.names.length;i++){if(serverData.names[i]!=serverNewData.names[i]){return false}}return true};var applyTo=function(otherData){var serverDiff=DataDiff(serverData,otherData);if(!serverDiff.rebaseable()){return null}var mergedData=otherData;var m=Model(function(d){mergedData=d});m.reset(otherData);var addPayment=function(payment){var rowIndex=mergedData.payments.length;m.addRow();m.updatePaymentText(payment.text,rowIndex);for(var j=0;j<payment.values.length;j++){m.updatePaymentValue(payment.values[j],rowIndex,j)}};for(var i=serverData.payments.length;i<localData.payments.length;i++){addPayment(localData.payments[i])}return mergedData};return{accepted:accepted,rebaseable:rebaseable,isEmpty:isEmpty,payment:paymentStats,name:nameStats,applyTo:applyTo}};var Model=function(onChangedCallback){var undoStack;var undoStackCursor;var currentData=function(){return $.extend(true,{},undoStack[undoStackCursor])};var onChanged=function(newData){undoStack=undoStack.slice(0,undoStackCursor+1);undoStack.push(newData);undoStackCursor++;onChangedCallback(newData)};var undo=function(){undoStackCursor=Math.max(0,undoStackCursor-1);onChangedCallback(undoStack[undoStackCursor])};var redo=function(){undoStackCursor=Math.min(undoStack.length-1,undoStackCursor+1);onChangedCallback(undoStack[undoStackCursor])};var reset=function(data){undoStack=[data];undoStackCursor=0};var addColumn=function(){var data=currentData();data.names.push(" ");$.each(data.payments,function(i,p){p.values.push(null)});onChanged(data)};var addRow=function(){var data=currentData();var numNames=data.names.length;var payment={text:" ",values:[]};for(var i=0;i<numNames;i++){payment.values.push(0)}data.payments.push(payment);onChanged(data)};var updateName=function(newName,i){var data=currentData();if(newName===""){data.names.splice(i,1);$.each(data.payments,function(j,p){p.values.splice(i,1)})}else{data.names[i]=newName}onChanged(data)};var updateTitle=function(newTitle){var data=currentData();data.title=newTitle;onChanged(data)};var updatePaymentText=function(newText,i){var data=currentData();if(newText===""){data.payments.splice(i,1)}else{data.payments[i].text=newText}onChanged(data)};var updatePaymentValue=function(newValue,i,j){var data=currentData();data.payments[i].values[j]=newValue;onChanged(data)};return{addColumn:addColumn,addRow:addRow,updateName:updateName,updatePaymentText:updatePaymentText,updatePaymentValue:updatePaymentValue,updateTitle:updateTitle,undo:undo,redo:redo,reset:reset}};var JobQueue=function(){var previous=(new $.Deferred).resolve();var add=function(fn){var wrap=function(){var d=new $.Deferred;fn(function(){d.resolve()},function(){d.reject();previous=(new $.Deferred).resolve()});return d};previous=previous.then(wrap,function(){})};return{add:add}};var NetworkStatus=function(){var listeners=[];var obj={isOnline:true,setOnline:function(isOnline){if(obj.isOnline!=isOnline){obj.isOnline=isOnline;$.each(listeners,function(i,l){l(isOnline)})}},onChanged:function(listener){listeners.push(listener)}};return obj};var Net=function(jobQueue,errorHandler,networkStatus){var pingTimer=null;var ajax=function(url,data,onSuccess,onError){$.ajax({type:"POST",url:"/"+url,data:JSON.stringify(data),contentType:"application/json",success:function(o){networkStatus.setOnline(true);onSuccess(o)},error:function(o){if(networkStatus.isOnline){errorHandler.info(L.OfflineMode);networkStatus.setOnline(false)}window.clearTimeout(pingTimer);pingTimer=window.setTimeout(function(){ajax("ping",{},function(){info(L.OnlineMode)},$.noop)},3e3);onError(o)}})};var create=function(onSuccess){ajax("create",{},function(response){onSuccess(response.url)},$.noop)};var read=function(idObj,onSuccess,onError){var success=function(response){if(response.err){info(response.err)}else{onSuccess(response)}};ajax("get",idObj,success,onError)};var update=function(doc,onSuccess,onConflict,onError){var resolve;var reject;var success=function(response){if(response.err){errorHandler.fatal(response.err);reject()}else if(response.ok){resolve();onSuccess()}else{var serverDoc={data:response.data,generation:response.generation,id:response.id};onConflict(serverDoc);reject()}};var error=function(err){resolve();onError(err)};jobQueue.add(function(resolveJob,rejectJob){resolve=resolveJob;reject=rejectJob;ajax("update",doc,success,error)})};var sendmail=function(message){ajax("sendmail",message,$.noop,$.noop)};return{create:create,update:update,read:read,sendmail:sendmail}};var RemoteDoc=function(id,net){var generation;var update=function(updateData,onSuccess,onConflict,onError){if(!generation){}var onConflictInternal=function(conflictDoc){var data=conflictDoc.data;generation=conflictDoc.generation;onConflict(data)};generation++;net.update({id:id,generation:generation,data:updateData},onSuccess,onConflictInternal,onError)};var read=function(onData,onError){net.read({id:id},function(doc){generation=doc.generation;onData(doc.data)},onError)};return{read:read,update:update,isFirstGeneration:function(){return generation==0}}};var LocalDoc=function(id,storage){var supported=function(){return storage!==undefined};var exists=function(key){return supported()&&storage[id+"_"+key]!==undefined};var update=function(key,data){if(supported()){if(data===undefined){delete storage[id+"_"+key]}else{storage[id+"_"+key]=JSON.stringify(data)}}};var read=function(key){if(!exists(key)){throw"local doc does not exist!"}return JSON.parse(storage[id+"_"+key])};return{update:update,read:read,exists:exists}};var DocProxy=function(localDoc,remoteDoc,networkStatus,errorHandler){var isFirstRead=true;var lastServerData;var onData;var onDataInternal=function(data){if(onData){onData(data)}};var update=$.noop;var read=function(){log("Read...");if(isFirstRead){isFirstRead=false;if(localDoc.exists("mine")!=localDoc.exists("theirs")){localDoc.update("mine");localDoc.update("theirs")}if(localDoc.exists("mine")){lastServerData=localDoc.read("theirs");onDataInternal(localDoc.read("mine"))}}if(networkStatus.isOnline){var onRemoteDocData=function(data){logData(data,"Read onData");if(lastServerData){var localDiff=DataDiff(lastServerData,localDoc.read("mine"));var anyLocalChanges=!localDiff.isEmpty();if(anyLocalChanges){if(DataDiff(lastServerData,data).rebaseable()){logData(lastServerData,"Merge base ");logData(data,"Merge their");logData(localDoc.read("mine"),"Merge mine ");data=localDiff.applyTo(data);update(data)}else{errorHandler.info("Internal Error: Could not merge local changes!")}}}if(JSON.stringify(data)!=JSON.stringify(lastServerData)){onDataInternal(data)}lastServerData=data;localDoc.update("mine",data);localDoc.update("theirs",data)};var onRemoteDocError=function(err){log("Read onError!");if(!lastServerData){errorHandler.fatal("Oooops!")}};remoteDoc.read(onRemoteDocData,onRemoteDocError)}if(!lastServerData&&!networkStatus.isOnline){errorHandler.fatal("Ooooops!")}};update=function(data){logData(data,"Update...");var onOffline=function(){log("Update offline!");if(DataDiff(lastServerData,data).accepted()){localDoc.update("mine",data)}else{errorHandler.info(L.OfflineMode);onDataInternal(localDoc.read("mine"))}};var onSuccess=function(){logData(data,"Update success");lastServerData=data;localDoc.update("mine",data);localDoc.update("theirs",data)};var updateConflictInternal=function(conflictData){logData(conflictData,"Update conflict!");var serverDiff=DataDiff(lastServerData,conflictData);var localDiff=DataDiff(lastServerData,data);if(serverDiff.rebaseable()&&localDiff.accepted()){var mergeData=localDiff.applyTo(conflictData);localDoc.update("mine",mergeData);localDoc.update("theirs",conflictData);lastServerData=conflictData;update(mergeData);onDataInternal(mergeData)}else{errorHandler.info(L.SomeoneMadeAChangeTryAgain);lastServerData=conflictData;localDoc.update("mine",conflictData);localDoc.update("theirs",conflictData);onDataInternal(conflictData)}};if(networkStatus.isOnline){remoteDoc.update(data,onSuccess,updateConflictInternal,onOffline)}else{onOffline()}};var setOnData=function(f){if(onData){errorHandler.fatal("Internal error: Must not set multiple onData handlers.")}onData=f};return{read:read,update:update,onData:setOnData,isFirstGeneration:function(){return remoteDoc.isFirstGeneration()}}};var addButtonCell=function(onclick){var c=$("<td/>").html("&nbsp;+&nbsp;");c.on("click",onclick);c.css("cursor","pointer");return c};var makeEditable=function($td,currentValue,onNewValue){currentValue=currentValue===null?"":currentValue+"";var $elem=$("<div/>").text(currentValue);$td.html($elem);$elem.off("blur");$elem.off("keydown");$elem.attr("contentEditable",true);$elem.on("blur",function(){var newValue=$(this).text();if(newValue!==currentValue){currentValue=newValue;onNewValue(newValue)}});$elem.on("keydown",function(e){if(e.which==13){e.preventDefault();$elem.blur()}})};var Table=function($header,$table,model,help,paymentWizard){var newRow=function(){return $("<tr/>")};var setup=function(){var $addColumnCell=addButtonCell(function(){model.addColumn();$(this).prev().find("div").text("").focus()});var $addRowCell=addButtonCell(function(){paymentWizard.start($table.find(".add-row-row"))});$table.empty().append(newRow().addClass("column-header-row").append($("<td/>").append(help.getShowHelpButton()),$addColumnCell.addClass("add-column-cell")),newRow().addClass("add-row-row").append($addRowCell.addClass("add-row-cell")),newRow().addClass("diff-row").append($("<td/>")));$table.off("keydown");$table.on("keydown",function(e){if(isCtrlY(e)||isCtrlZ(e)){return false}});$(window).off("keydown");$(window).on("keydown",function(e){if(isCtrlY(e)){model.redo();return false}if(isCtrlZ(e)){model.undo();return false}})};var updatePaymentPlan=function(data,plan){$table.find(".transfer-plan").remove();$table.append($("<tr><td>&nbsp;</td></tr>").addClass("transfer-plan"));$.each(plan,function(i,moneyTransfer){var longRow=function(text){var tr=$("<tr/>").addClass("transfer-plan");var td=$("<td colspan="+(data.names.length+1)+"/>");if(text){td.text(text)}else{td.html("&nbsp;")}return tr.append(td)};var mt=moneyTransfer;if(mt.amount>.005){$table.append(longRow(data.names[mt.from]+" "+L.ShouldGive+" "+mt.amount.toFixed(2)+" "+L.To+" "+data.names[mt.to]))}})};var updatePyjamasClasses=function(){$table.find("tr").each(function(i){if(i%2==0){$(this).addClass("even")}else{$(this).removeClass("even")}})};var updateHeader=function(data){makeEditable($header,data.title,function(newTitle){if(newTitle==""){newTitle="..."}model.updateTitle(newTitle)})};var updateTotalDiffRow=function(data){var $diffRow=$table.find(".diff-row");$diffRow.find(".diff-cell").remove();var totalDiffs=new Array(data.names.length);for(var i=0;i<totalDiffs.length;i++)totalDiffs[i]=0;$(data.payments).each(function(i,payment){var rowSum=0;var rowCount=0;$(payment.values).each(function(i,value){if(value!==null){rowSum+=value;rowCount++}});$(payment.values).each(function(i,value){if(value!==null){totalDiffs[i]+=value-rowSum/rowCount}})});for(var i=0;i<totalDiffs.length;i++){var twoDecimals=totalDiffs[i].toFixed(2);$diffRow.append($("<td/>").addClass("diff-cell").text(twoDecimals).css("color",twoDecimals>0?"limegreen":twoDecimals<0?"salmon":""))}$diffRow.append($("<td/>").addClass("diff-cell"));return totalDiffs};var updateNamesAndPayments=function(data){var d3table=d3.select($table[0]);var firstRowCell=d3table.select("tr").selectAll("td.cell").data(data.names);firstRowCell.enter().insert("td",".add-column-cell").attr("class","cell");firstRowCell.each(function(d,i){makeEditable($(this),d,function(newValue){model.updateName(newValue,i)})});firstRowCell.exit().remove();var paymentRow=d3table.select("tbody").selectAll("tr.payment-row").data(data.payments);var paymentRowEnter=paymentRow.enter().insert("tr",".add-row-row").attr("class","payment-row");paymentRowEnter.append("td");paymentRowEnter.append("td").attr("class","tombstone");paymentRow.select("td").attr("class","payment-text").each(function(d,i){makeEditable($(this),d.text,function(newValue){model.updatePaymentText(newValue,i)})});paymentRow.exit().remove();var paymentCell=paymentRow.selectAll("td.cell").data(function(d){return d.values});paymentCell.enter().insert("td",".tombstone");paymentCell.attr("class",function(value){return value===null?"cell nullvalue":"cell"}).style("background-color","").each(function(value,i,j){var $cell=$(this);makeEditable($cell,value,function(newValue){newValue=newValue.replace(/,/g,".");if(isValidCellValue(newValue)){$cell.css("background-color","");model.updatePaymentValue(toValidCellValue(newValue),j,i)}else{$cell.css("background-color","lightsalmon")}})});paymentCell.exit().remove()};var update=function(data){$table.find("*").off("blur");updateHeader(data);updateNamesAndPayments(data);var diffs=updateTotalDiffRow(data);updatePaymentPlan(data,transferPlan(diffs));updatePyjamasClasses()};setup();return{update:update}};var Help=function($helpContainer,net,networkStatus,highlightHelpButtonFunc){$helpContainer.addClass("help-container yellow");var text=function(content){return $("<div/>").addClass("help-text").append($("<span/>").html(content))};var header=function(content){return $("<div/>").addClass("help-header").append($("<span/>").html(content))};$helpContainer.append(header("&nbsp;"),header(L.HelpHeader1),text(L.HelpText1),header(L.HelpHeader2),text(L.HelpText2),header(L.HelpHeader3),text(L.HelpText3),header(L.HelpHeader4),text(L.HelpText4),header(L.HelpHeader5),text(L.HelpText5),text("&nbsp;"));var $comment=$("<span/>");var emailSent=false;var updateSubmitButton;var $textArea=$("<textarea/>").addClass("help-submit").attr("cols",40).attr("rows",8).on("input paste",function(){updateSubmitButton()});var $inputEmail=$("<input/>").addClass("help-submit").attr("placeholder",L.ExampleEmail).on("input paste",function(){updateSubmitButton()});var $submit=$("<button/>").html(L.SubmitFeedback).addClass("help-submit").on("click",function(){net.sendmail({message:$textArea.val(),from:$inputEmail.val()});emailSent=true;updateSubmitButton();$submit.html(L.ThankYou);setTimeout(function(){$textArea.val("");emailSent=false;$submit.html(L.SubmitFeedback);updateSubmitButton()},2e3)});updateSubmitButton=function(){var enabled=networkStatus.isOnline&&$textArea.val()!=""&&!emailSent&&$inputEmail.val().search(/^[a-zA-Z0-9\.]+@[a-zA-Z0-9]+\.[a-zA-Z]+$/)>-1;$submit.attr("disabled",!enabled)};networkStatus.onChanged(function(){updateSubmitButton()});$helpContainer.append($comment.append($textArea,$("<br/>"),$inputEmail,$("<br/>"),$submit));updateSubmitButton();var visible=false;var toggle=function(){if(visible){$helpContainer.slideUp()}else{$helpContainer.slideDown()}visible=!visible};var getShowHelpButton=function(){var $highlighter=$("<span/>").html("&nbsp;&nbsp;&nbsp;&#x2190;&nbsp;"+L.Help).hide();var $helpButton=$("<span/>").append($("<span/>").html("&nbsp;&#x2261;&nbsp;"),$highlighter).css("cursor","pointer").on("click",function(){highlightHelpButtonFunc=function(){return false},toggle()});var toggleHighlight=function(){if(highlightHelpButtonFunc()){$highlighter.fadeToggle("fast")}else{$highlighter.hide()}setTimeout(toggleHighlight,750)};toggleHighlight();return $helpButton};return{getShowHelpButton:getShowHelpButton}};var isCtrlZ=function(e){e=window.event||e;return e.keyCode==90&&e.ctrlKey};var isCtrlY=function(e){e=window.event||e;return e.keyCode==89&&e.ctrlKey};var showMessage=function(message,delay){$(".messagecontainer").empty();var $message=$("<div/>").addClass("message yellow info").text(message).hide();$(".messagecontainer").append($message);var timer=null;var obj={hide:function(){$message.slideUp();obj.hide=$.noop;clearTimeout(timer)}};$message.slideDown("fast");timer=setTimeout(function(){$message.slideUp()},delay||3e3);return obj};var bailout=function(message){showMessage(message||L.UnknownErrorReloadPage);setTimeout(function(){window.location.href=window.location.href},3e3)};var info=function(message,delay){return showMessage(message,delay)};var setOnlineCss=function(isOnline){if(isOnline){$(".root").removeClass("offline")}else{$(".root").addClass("offline")}};var log=function(message){if(false){console.log(message)}};var logData=function(data,message){if(message){log(message)}var str="";for(var i=0;i<data.payments.length;i++){str+=data.payments[i].text+", "}log(" - "+str)};
//# sourceMappingURL=source.js.map